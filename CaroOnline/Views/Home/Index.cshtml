@using CaroOnline.Helper
@using CaroOnline.Models
@model List<Users>
@{
    ViewBag.Title = "Index";
}

<div class="col-lg-9 col-md-9 col-sm-12" >
    <!-- Nav tabs -->
    <ul class="nav nav-tabs nav-justified indigo rounded p-2" role="tablist" style="background-image: linear-gradient(60deg, #3d3393 0%, #2b76b9 37%, #2cacd1 65%, #35eb93 100%);">
        <li class="nav-item">
            <a class="nav-link active h4-responsive" data-toggle="tab" href="#panel5" role="tab"><i class="fa fa-users mr-2"></i>NGƯỜI CHƠI</a>
        </li>
        <li class="nav-item">
            <a class="nav-link h4-responsive" data-toggle="tab" href="#panel6" role="tab"><i class="fa fa-sticky-note-o mr-2"></i> LUẬT CHƠI</a>
        </li>
        @*<li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#panel7" role="tab"><i class="fa fa-envelope"></i> Mail</a>
            </li>*@
    </ul>
    <!-- Tab panels -->
    <div class="tab-content grey lighten-3 card px-1 rounded pb-4" style="">
        <!--Panel 1-->
        <div class="tab-pane fade in show active" id="panel5" role="tabpanel">
            <div class="card-body pt-2">

                @*<div id="test"><button class="btn btn-default" id="btnTest">Test</button></div>*@
                <div class="row" id="ViewUsers">
                </div>
            </div>
        </div>
        <!--/.Panel 1-->
        <!--Panel 2-->
        <div class="tab-pane fade text-center px-5" id="panel6" role="tabpanel">
            <h2 class="success-text mb-2">LUẬT CHƠI CỜ CARO</h2>
            <hr class="success-color d-inline-block mt-0 mb-3" style="width:25%;height:2px" />
            <p class="h5 ">
                Người chơi có 5 quân cờ liên tiếp theo hàng ngang,dọc,chéo trước sẽ chiến thắng.

            </p>
            <p class=" px-5 h5">
               <span class="success-text">Thắng: +80 điểm.</span>
                
                <span class="danger-text">Thua : -100 điểm.</span> 

                <span class="primary-text">Hòa : +0 điểm.</span> 
            </p>
            
        </div>
        <!--/.Panel 2-->
        <!--Panel 3-->
        @*<div class="tab-pane fade" id="panel7" role="tabpanel">
                <br>
                <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Nihil odit magnam minima, soluta doloribus reiciendis molestiae placeat unde eos molestias. Quisquam aperiam, pariatur. Tempora, placeat ratione porro voluptate odit minima.</p>
            </div>*@
        <!--/.Panel 3-->
    </div>

</div>
<div class="modal fade show" id="modalLoginAvatarDemo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog cascading-modal modal-avatar modal-md" role="document">
        <!--Content-->
        <div class="modal-content">

            <!--Body-->
            <div class="modal-body text-center mb-1 px-2">
                <h2 class="red-text modal-title font-weight-bold">MỜI THÁCH ĐẤU</h2>
                <hr class="red d-inline-block mt-0 mb-3" style="width:25%;height:2px" />

                <div class="row">
                    <div class="col-6  d-flex justify-content-end">
                        <h5 class="black-text h5 "><i class="fa fa-user-circle"></i> Người mời :</h5>
                    </div>
                    <div class="col-6  d-flex justify-content-start">
                        <h4 class="primary-text" id="UNamePairing"></h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6  d-flex justify-content-end">
                        <h5 class="black-text h5 "><i class="fa fa-clock-o"></i>Thời gian chờ : </h5>
                    </div>
                    <div class="col-6  d-flex justify-content-start">
                        <div class="progress my-1" style="height: 20px">
                            <div id="TimeCount" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%; height: 20px" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        @*<div class="progress mt-3 mb-0" style="width:40%">
                            <div id="TimeCount" class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>*@
                    </div>
                </div>
                
                <div class="text-center">
                    <button class="btn btn-teal mt-1 waves-effect waves-light btn-md " style="font-size:.8rem" id="btnYes">
                        Đồng ý <i class="fa fa-chevron-circle-right ml-1"></i>
                        
                    </button>
                    <button class="btn btn-outline-teal mt-1 waves-effect waves-light btn-md" style="font-size:.8rem" id="btnNo">
                        Từ chối<i class="fa fa-ban ml-1"></i>
                        
                    </button>
                </div>
            </div>

        </div>
        <!--/.Content-->
    </div>
</div>

<!-- Modal restart game-->

<div class="modal fade show" id="modalRestart" tabindex="-1" role="dialog" aria-labelledby="lblSave" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog cascading-modal modal-avatar modal-md" role="document">
        <!--Content-->
        @*<h5 class="modal-title" id="lblSave">Thông báo</h5>*@
        <div class="modal-content">

            <!--Body-->
            <div class="modal-body text-center  px-2 py-1">

                <div>
                    <h4 id="lblloaderRestart"></h4>
                    <img src="~/Content/loading.svg" style="width:40px;height:40px" />
                </div>

                <button class="btn btn-outline-danger" id="btnOkRestart"><i class="fa fa-check mr-2"></i>Đồng ý</button>
                <button class="btn btn-danger" id="btnNotOkRestarts" data-dismiss="modal"><i class="fa fa-close mr-2"></i>Không đồng ý</button>
            </div>

        </div>
        <!--/.Content-->
    </div>
</div>

@section js{
    <script src="~/Scripts/jquery.signalR-2.2.2.js"></script>
    @*<script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>*@
    <script src="~/signalr/hubs"></script>
    <script>

        $(document).ready(function () {
            var t = "@ViewBag.msgError";
            if (t != "") {
                toastr.error(t, "Thông báo", {
                    "positionClass": "toast-top-right",
                });
            }
            t = "@ViewBag.msgSuccess";
            if (t != "") {
                toastr.success(t, "Thông báo", {
                    "positionClass": "toast-top-right",
                });
            }
            t = "@ViewBag.NotPairing";
            if (t != "") {
                toastr.error(t, "Thông báo", {
                    "positionClass": "toast-top-right",
                });
            }
            var user =@Html.Raw(Json.Encode(CurrentContext.GetCurUser()));
            var login = 1;
            var countTime=null;
            // Reference the auto-generated proxy for the hub.
            $.connection.hub.qs = { 'Uname' : user.Name };
            var chat = $.connection.onlineHub;
            var linkback = "",fromback="";
            chat.client.restartGame = function (from, link) {
                linkback = link;
                fromback = from;
                $("#modalRestart").modal("toggle");
                $("#lblloaderRestart").text("Người chơi " + from + " muốn tiếp tục trận đấu đã lưu với bạn.");
            }            
            chat.client.okRestart = function (link) {
                window.location.href = link;
            }
            //$.connection.onlineHub.qs="Uname="+user.Name;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                // Add the message to the page.
                $('#test').append('<p>'+   name + '-' + message+'</p>');
            };
            chat.client.sendTo = function (name, message,id) {
                // Add the message to the page.
                $('#test').append('<p>'+ name + '-' + message+' - ' +id +'</p>');
            };

            chat.client.updateConnectionID=function(listUsers){
                //console.log(listUsers);

                listUsers.forEach(function(item){
                    $("#"+item.Name).data("cID",item.cID);
                });

                //for (var i = 0; i < listUsers.length; i++) {
                //    $()
                //}
            }
            chat.client.reloadUsers=function(){
                $.ajax({
                    url:"/Home/ReloadUser",
                    success: function (data) {
                        $("#ViewUsers").html("");
                        if (data == "") {
                            $("#ViewUsers").append('<p id="noDataFound" class="text-muted">Không có tài khoản online.</p>');
                            return;
                        }
                        //$("#ViewUsers").html("");
                        data.forEach(function (item) {

                            //if($("#"+item.Name).length){
                            //    return;
                            //}
                            var html='<div class="col-lg-3 col-md-3 col-sm-6 mb-2 px-3 User" id="'+item.Name+'" data-uID="'+item.ID+'" data-cnnID="'+item.CID+'">'+
                            '<div class="card text-center hoverable  view overlay hm-white-light hm-zoom">'+
                                '<div class="card-body px-5 ">'+
                                    '<img src="/Content/default_user.png"  class="img-fluid rounded-circle z-depth-1-half">'+
                                '</div>'+
                                '<h5 class="card-title primary-text blue-grey lighten-4 py-1 mb-1 font-weight-bold">'
                                    +item.Name+
                                    '<i class="fa fa-circle success-text ml-2"></i>'+
                                '</h5>'+

                                '<div class="my-2 card-text text-left px-0 d-flex justify-content-between text-center px-1">'+
                                '<h5 class="mb-0"><span class="badge green darken-2 font-weight-light pr-2 pb-1">Thắng</span>&nbsp; <strong class="green-text">' + item.Win +'</strong></h5>'+
                                '<h5 class="mb-0"><span class="badge  red accent-4 font-weight-light pr-2 pb-1">Thua</span>&nbsp;<strong class="red-text">' + item.Lost +'</strong></h5>'+
                                '<h5 class="mb-0"><span class="badge  unique-color-dark font-weight-light pr-2 pb-1">Hòa</span>&nbsp;<strong class="grey-text">' + item.Equal +'</strong></h5>'+
                                '<h5 class="mb-0 border border-primary"><span class="badge   blue darken-2 font-weight-light px-2 pb-1">Điểm</span>&nbsp;<strong class="blue-text">' + item.Point +'</strong></h5>'+
                                '</div>'+
                                '<div class="card-footer px-0 pt-1 mb-0 pb-0">'+
                                '<button class="btn btn-md  btn-danger btn-block btnPlay"  data-uName="' + item.Name +'" data-cnnID="' + item.CID + '" data-uID="' + item.ID +'">Thách đấu</button>'+
                                '</div>'+
                            '</div>'+
                        '</div>';


                        //    var html='<div class="col-2 mb-2 px-1 User" id="'+item.Name+'" data-uID="'+item.ID+'" data-cnnID="'+item.CID+'">'+
                        //        '<div class="card text-center">' +

                        //        '<div class="card-body px-5 ">'+
                        //            '<img src="/Content/default_user.png"  class="img-fluid rounded-circle z-depth-1-half">'+
                        //        '</div>'+
                        //        '<h6 class="card-title primary-text grey lighten-4 py-1 mb-1 ">'+
                        //            item.Name +
                        //                '&nbsp;&nbsp;<i class="fa fa-circle success-text"></i>'+
                        //        '</h6>'+
                        //        '<p class=" danger-text mb-0 pb-1">500&nbsp;<i class="fa fa-star"></i></p>' +
                        //        '<button type="button" class="btn btn-primary btn-md ">Thách đấu</button>'+
                        //        '<div class="card-footer px-0 pt-0 pt-1">'+
                        //            '<a class="btn-floating  btn-sm success-color m-0 white-text pr-1"><i class="fa fa-bolt">10</i></i></a>'+
                        //            '<a class="btn-floating btn-sm special-color my-0 mx-1 white-text pr-1"><i class="fa fa-minus">10</i></a>'+
                        //            '<a class="btn-floating btn-sm danger-color m-0 white-text pr-1"><i class="fa fa-ban">10</i></a>'+
                        //        '</div>'+
                        //    '</div>'+
                        //'</div>';

                            $("#ViewUsers").append(html);
                        });
                        $("#noDataFound").hide();
                    },
                    error:function(){
                        // alert("Error Call Reload User");
                        console.log("Error Call Reload User");
                    }

                });
            }
            chat.client.pairingGame = function (uNameFrom, uCnnIdFrom ,uNameTo) {
                $("#UNamePairing").text(uNameFrom.trim());
                $("#btnNo").data("ucnnidfrom", uCnnIdFrom.trim());
                $("#btnYes").data("ucnnidfrom", uCnnIdFrom.trim());
                $("#btnYes").data("uNamefrom", uNameFrom.trim());
                $('#modalLoginAvatarDemo').modal('toggle');
                var ms = 10;
                $("#TimeCount").removeClass();  
                $("#TimeCount").addClass("progress-bar bg-success");  
                countTime=setInterval(function () {
                    if(ms<7 && ms >4){
                        $("#TimeCount").removeClass("bg-success");
                        $("#TimeCount").addClass("bg-primary");
                    }
                    if(ms<=4 && ms >2){
                        $("#TimeCount").removeClass("bg-primary");
                        $("#TimeCount").addClass("bg-warning");
                    }
                    if(ms<=2){
                        $("#TimeCount").removeClass("bg-warning");
                        $("#TimeCount").addClass("bg-danger");
                    }
                    
                    var per=ms*10;
                    $("#TimeCount").attr("aria-valuenow",per);
                    $("#TimeCount").css("width",per+"%");
                    ms = ms - 0.01;
                    if (ms < 0) {
                        clearInterval(countTime);
                        $('#modalLoginAvatarDemo').modal('toggle');
                        $("#btnNo").trigger("click");
                    }
                },10);
            }
            chat.client.noPairing = function (userCnnIDTo, uNameFrom, uCnnIdFrom) {
                var msg = "Người chơi <i><u>" + uNameFrom.trim() + "</u></i> không đồng ý thách đấu !";
                //alert("Không đồng ý!");
                //alert("Không đồng ý");
                //console.log("không đồng ý");
                toastr.error(msg, "Thông báo", {
                    "positionClass": "toast-top-right",
                    "closeButton":true,
                    "newestOnTop": true, // true/false
                    "progressBar": true,
                    "timeOut": "10000", 
                });
                $(".btnPlay[data-uname='" + uNameFrom.trim() + "']").text("Thách đấu");
                $(".btnPlay[data-uname='" + uNameFrom.trim() + "']").prop("disabled",false);
            }
            chat.client.yesPairing = function (cnnIDFrom, cnnIDTo, uNameFrom, uNameTo) {
                window.location.href = '/Home/Play?uname1=' + uNameFrom + '&uname2=' + uNameTo ;

                //var msg = "Người chơi <i><u>" + uNameFrom.trim() + "</u></i> không đồng ý thách đấu !";
                ////alert("Không đồng ý!");
                ////alert("Không đồng ý");
                ////console.log("không đồng ý");
                //toastr.error(msg, "Thông báo", {
                //    "positionClass": "toast-top-right",
                //    "closeButton": true,
                //    "newestOnTop": true, // true/false
                //    "progressBar": true,
                //    "timeOut": "10000",
                //});
                //$(".btnPlay[data-uname='" + uNameFrom.trim() + "']").text("Thách đấu");
                //$(".btnPlay[data-uname='" + uNameFrom.trim() + "']").prop("disabled", false);
            }
            
            // Start the connection.
            $.connection.hub.start().done(function () {
                $("#btnNotOkRestarts").on("click", function () {
                    chat.server.notOkRestart(fromback);
                });

                $("#btnOkRestart").on("click", function () {
                    window.location.href = linkback;
                    chat.server.okRestart(fromback, linkback)
                });

                $('#currConnectID').val($.connection.hub.id);
               // chat.server.updateConnectionID();
                $('#btnTest').on('click',function(){
                    chat.server.send(user.Name,'ND');
                    chat.server.sendTo(user.Name,'To',1);
                });
                $("#ViewUsers").on("click", ".btnPlay", function () {
                    //alert("Play");
                    var userToID = $(this).data("uid");
                    var userToCnnID = $(this).data("cnnid");
                    var uNameTo = $(this).data("uname");
                    var uNameFrom = $("#currUserName").text();
                    chat.server.pairingGame(uNameFrom,userToID, uNameTo, userToCnnID);
                    $(this).text("Đang chờ ...");
                    $(this).prop("disabled", "disabled");
                });
                $("#btnYes").on("click", function () {

                    var uNameFrom = $("#currUserName").text().trim();
                    var cnnIDFrom = $("#currConnectID").val().trim();
                    var uNameTo = $(this).data("uNamefrom").trim();
                    var cnnIDTo = $(this).data("ucnnidfrom").trim();
                    chat.server.yesPairing(cnnIDFrom, cnnIDTo);
                    window.location.href = '/Home/Play?uname1=' + uNameFrom +  '&uname2=' + uNameTo;

                });
                $("#btnNo").on("click", function () {
                    var userCnnIDTo = $(this).data("ucnnidfrom");
                    var uNameFrom = $("#currUserName").text();
                    $('#modalLoginAvatarDemo').modal('toggle');
                    clearInterval(countTime);
                    chat.server.noPairing(userCnnIDTo, uNameFrom);
                });


            });

        });

    </script>

}